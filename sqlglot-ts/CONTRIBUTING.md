# Contributing to sqlglot-ts

## Setup

```bash
git clone <repo-url>
cd sqlglot-ts
pnpm install
```

## Development commands

| Command | Description |
|---------|-------------|
| `pnpm test` | Run all tests once |
| `pnpm test:watch` | Run tests in watch mode |
| `pnpm run typecheck` | Type-check without emitting (runs `tsc --noEmit`) |
| `pnpm run build` | Build the package with tsdown |

## Running a single test file

```bash
pnpm vitest run tests/smoke.test.ts
```

## Adding tests

Test files live under `tests/` and must use the `.test.ts` extension. Dialect-specific tests go under `tests/dialects/`. Use vitest's `describe` and `it` blocks:

```typescript
import { describe, it, expect } from "vitest";
import { parseOne } from "../src/index.js";

describe("my feature", () => {
  it("parses and regenerates SQL", () => {
    expect(parseOne("SELECT 1").sql()).toBe("SELECT 1");
  });
});
```

For round-trip identity tests (parse then generate should produce the same SQL), use the `validateIdentity` helper from `tests/helpers.ts` once it is available. The pattern is:

```typescript
function validateIdentity(sql: string, opts?: { dialect?: string }) {
  const tree = parseOne(sql, opts);
  expect(tree.sql(opts)).toBe(sql);
  return tree;
}
```

## Adding a new Expression class

Expression classes live in `src/expressions.ts`. Most are generated by `scripts/codegen_expressions.py` from the Python codebase. To add one manually:

1. Define the class extending the appropriate base (`Expression`, `Condition`, `Query`, etc.).
2. Set `static argTypes` to declare accepted arguments (key is name, value is whether it is required).
3. Set `static key` to a unique lowercase identifier.
4. Add typed property getters for each argument.

```typescript
export class MyExpr extends Expression {
  static override argTypes: Record<string, boolean> = { this: true, flag: false };
  static override key = "myexpr";

  get flag(): boolean {
    return !!this.args["flag"];
  }
}
```

After adding the class, register it in the `EXPRESSION_CLASSES` map at the bottom of `expressions.ts` if one exists, or verify it is picked up by the codegen registry.

## Adding a new dialect

Dialect files live in `src/dialects/`. To add a new dialect:

1. Create `src/dialects/<name>.ts`.
2. Export a class extending `Dialect` with nested `Tokenizer`, `Parser`, and `Generator` classes as needed.
3. Register the dialect name in the `Dialect` registry (typically via a static `dialectName` property or by calling `Dialect.register()`).
4. Add the export to `src/dialects/index.ts` and to the `exports` field in `package.json`.
5. Add tests in `tests/dialects/test_<name>.test.ts`.

## Code style

- TypeScript strict mode is enabled. All code must pass `pnpm run typecheck`.
- Use camelCase for functions and methods, PascalCase for classes.
- No runtime dependencies. Dev dependencies only for build and test tooling.
- Prefer existing expression classes over `Anonymous`. Check `expressions.ts` before creating ad-hoc nodes.

## Codegen scripts

Two Python scripts in `scripts/` automate porting from the Python codebase:

- `codegen_expressions.py` -- generates `src/expressions.ts` from Python's `sqlglot/expressions.py`
- `codegen_tests.py` -- converts Python unittest files to vitest format

Run these from the repository root with Python 3 and the `sqlglot` package installed.
